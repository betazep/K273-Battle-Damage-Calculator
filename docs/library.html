<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="library.title">K273 Library</title>
    <link rel="icon" href="images/favicon.ico" sizes="any">
    <link rel="icon" href="images/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="images/favicon-16.png" type="image/png" sizes="16x16">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="css/styles.css?v=1.0.15">
</head>
<body>
    <header class="hero">
        <div class="page-lang">
            <div class="lang-control">
                <label for="site-language" data-i18n="site.languageLabel">Language</label>
                <select class="lang-select" id="site-language">
                    <option value="en" selected>English</option>
                    <option value="de">Deutsch</option>
                    <option value="es">Español</option>
                    <option value="fr">Français</option>
                    <option value="it">Italiano</option>
                    <option value="no">Norsk</option>
                    <option value="pl">Polski</option>
                    <option value="pt">Português</option>
                    <option value="ru">Русский</option>
                    <option value="fi">Suomi</option>
                    <option value="sv">Svenska</option>
                </select>
            </div>
        </div>
        <div class="hero__content">
            <p class="eyebrow" data-i18n="library.hero.eyebrow">K273 | Library</p>
            <h1 data-i18n="library.hero.title">Library of Knowledge</h1>
            <p class="lede" data-i18n="library.hero.lede">Guides, references, and best practices for the kingdom.</p>
            <div class="hero__actions">
                <a class="btn ghost btn-small" href="index.html" data-i18n="library.hero.back">← Back to Home</a>
            </div>
        </div>
    </header>

    <main class="page">
        <section class="panel panel--plain">
            <div class="library-intro">
                <div class="library-intro__media">
                    <img src="images/tome-of-knowledge.png" alt="Library of Knowledge" loading="lazy" data-i18n-attr="alt:library.image.alt">
                </div>
                <div class="library-intro__text">
                    <p class="eyebrow" data-i18n="library.section.eyebrow">Library</p>
                    <h2 data-i18n="library.section.title">Library of Knowledge</h2>
                    <p class="small" data-i18n="library.section.sub">COMING SOON</p>
                </div>
            </div>
        </section>

        <section class="panel library-panel">
            <div class="library-controls">
                <div class="library-search">
                    <label for="library-search" data-i18n="library.search.label">Search books</label>
                    <input id="library-search" type="search" autocomplete="off" data-i18n-attr="placeholder:library.search.placeholder">
                </div>
                <div class="library-count" id="library-result-count">12 books</div>
            </div>
            <div class="library-results is-hidden" id="library-results" aria-live="polite"></div>
            <div class="library-outline" id="library-outline"></div>
        </section>
    </main>

    <div class="book-modal" id="book-modal" aria-hidden="true">
        <div class="book-modal__overlay" data-book-close></div>
        <div class="book-modal__panel" role="dialog" aria-modal="true" aria-labelledby="book-title">
            <button class="book-modal__close" type="button" data-book-close data-i18n-attr="aria-label:library.modal.close">×</button>
            <p class="eyebrow" id="book-category" data-i18n="library.modal.category">Category</p>
            <h3 id="book-title">Book</h3>
            <div class="book-modal__media is-hidden" id="book-media">
                <img src="" alt="" id="book-image">
            </div>
            <div class="book-modal__content" id="book-content"></div>
            <div class="book-modal__actions">
                <button class="btn ghost btn-small" type="button" data-book-close data-i18n="library.modal.back">Back to Library</button>
            </div>
        </div>
    </div>

    <div class="footer-actions">
        <a class="btn ghost btn-small" href="index.html" data-i18n="library.back">← Back to Home</a>
    </div>

    <footer class="footer">
        <p data-i18n="site.footer">Built for K273 by Zee</p>
    </footer>

    <script src="js/i18n.js?v=1.0.13"></script>
    <script src="js/lang.js"></script>
    <script>
        (() => {
            const lorem =
                "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer suscipit, augue et finibus gravida, " +
                "nisi nisl eleifend mi, vitae sagittis ipsum lacus et velit. Curabitur sit amet lorem ac elit varius " +
                "interdum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; " +
                "praesent nec odio vel sapien posuere mattis. Morbi facilisis, neque at viverra ultricies, nulla orci " +
                "tincidunt metus, sed feugiat lectus ipsum sit amet purus. Proin tincidunt, urna a luctus commodo, " +
                "elit augue fermentum risus, at consequat arcu magna non nunc. Aliquam erat volutpat. Sed et purus " +
                "eget orci efficitur venenatis. Vivamus ac quam id nisl porttitor volutpat. Pellentesque habitant morbi " +
                "tristique senectus et netus et malesuada fames ac turpis egestas. Cras in dignissim erat, non " +
                "vehicula risus. Suspendisse potenti. Mauris ac ex nec lorem cursus tincidunt.";

            const ancientVaultsContent = `
                <p><strong>Courtesy of [BBD] Heisenberg</strong></p>
                <div class="book-section">
                    <h4>How to build your vault</h4>
                    <ul>
                        <li>Complete daily quests.</li>
                        <li>Summon your vault in the Events tab.</li>
                        <li>Call your raid.</li>
                        <li>Kick players who don't follow the information below.</li>
                        <li>Full raids of 5 players only or cancel them.</li>
                    </ul>
                </div>
                <div class="book-section">
                    <h4>Raid strategy and vault colors</h4>
                    <ul>
                        <li>Green: G2 minimum.</li>
                        <li>Blue: G3 minimum.</li>
                        <li>Purple: G4 minimum.</li>
                        <li>Gold: G5 minimum.</li>
                        <li>Red: G6 minimum.</li>
                        <li>Silver: G7 minimum.</li>
                    </ul>
                </div>
                <p>Don't join a raid if you are below the minimum Guardsmen level. If others join your raid below the minimum level please remove them from the raid.</p>
                <div class="book-section">
                    <h4>Troop strategy</h4>
                    <ul>
                        <li>Fighting Captains only.</li>
                        <li>Vault Level 1-19: Use Mounted &amp; Range.</li>
                        <li>Vault Level 20-29: Use Mounted.</li>
                        <li>Vault Level 30-39: Use Spearmen &amp; Archers.</li>
                    </ul>
                </div>
            `;

            const tinmanContent = `
                <p><strong>Courtesy of [BBD] Heisenberg</strong></p>
                <p>Rise of the Ancients troop strategy (Tinman).</p>
                <div class="book-section">
                    <h4>Minimum ratio</h4>
                    <ul>
                        <li>1: Rider</li>
                        <li>2: Archers</li>
                        <li>2: Spearmen</li>
                    </ul>
                </div>
                <div class="book-section">
                    <h4>Example</h4>
                    <ul>
                        <li>G1 — Riders: 500, Archers: 1000, Spearmen: 1000</li>
                        <li>G2 — Riders: 250, Archers: 500, Spearmen: 500</li>
                    </ul>
                </div>
                <p>Adjust these numbers to the capacity of your Captain. Add mercenaries and monsters.</p>
                <div class="book-section">
                    <h4>Don't take</h4>
                    <ul>
                        <li>Catapults</li>
                        <li>Spies</li>
                        <li>Swordsmen</li>
                    </ul>
                </div>
                <p>Attack as much as you can in order to earn as many clan chests as possible. The Event tab will show you how many points you need for each chest.</p>
            `;

            const citadelContent = `
                <p><strong>Courtesy of [LTZ] Badder</strong></p>
                <p>If you use higher tier catapults than what is listed, only half the amount needs to be sent.</p>
                <div class="book-section">
                    <h4>Elven citadels</h4>
                    <ul>
                        <li><strong>Level 10</strong>: 100 tier 2 catapults. Only ranged + Gargoyles.</li>
                        <li><strong>Level 15</strong>: 320 tier 3 catapults. Only Mounted + Gargoyles, Boars and Phoenix.</li>
                        <li><strong>Level 20</strong>: 800 tier 4 catapults. Only Melee + Griffins.</li>
                        <li><strong>Level 25</strong>: 3200 tier 5 catapults. Only Melee + Griffins.</li>
                        <li><strong>Level 30</strong>: Boop &amp; pray, tier 6 catapults. Only Melee + Griffins.</li>
                    </ul>
                </div>
                <div class="book-section">
                    <h4>Cursed citadels</h4>
                    <ul>
                        <li><strong>Level 20</strong>: 2000 tier 4 catapults. Only Melee + Griffins.</li>
                        <li><strong>Level 25</strong>: 7800 tier 5 catapults. Only Melee + Griffins.</li>
                    </ul>
                </div>
                <p><em>Units listed in brackets () are optional.</em></p>
            `;

            const hallOfFameContent = `
                <p><strong>Courtesy of [LTZ] Badder</strong></p>
                <p>The Hall of Fame can be found using the small lion icon on the left of where you see your hero's armor. It is composed of three factions: Tenacity, Courage, and Resolve. Your captains are evenly divided into these three factions.</p>
                <div class="book-media-grid">
                    <img src="library-images/library-000.png" alt="Hall of Fame factions">
                </div>
                <div class="book-section">
                    <h4>Faction bonuses</h4>
                    <ul>
                        <li>Tenacity (blue wolf): Improve your army's resilience and defensive strength.</li>
                        <li>Courage (red lion): Enhance your offensive power and increase damage output.</li>
                        <li>Resolve (green hawk): Boost your army's stability and efficiency.</li>
                    </ul>
                </div>
                <p>This video provides a brief overview of each faction:</p>
                <p><a href="https://www.youtube.com/watch?v=ijGgrd4uaew">https://www.youtube.com/watch?v=ijGgrd4uaew</a></p>
                <div class="book-section">
                    <h4>Captain rarities</h4>
                    <ul>
                        <li>Rare (blue background)</li>
                        <li>Epic (purple background)</li>
                        <li>Legendary (orange/gold background)</li>
                    </ul>
                </div>
                <p>Faction upgrades require captains of a specific rarity to meet certain level conditions, shown in red at the bottom of the faction.</p>
                <div class="book-media-grid">
                    <img src="library-images/library-001.png" alt="Hall of Fame faction upgrade details">
                </div>
                <p>Upgrade each faction to unlock stronger permanent bonuses for your entire army. Click the round table beneath the three stained glass windows to see the requirements for upgrading your Hall of Fame level.</p>
            `;

            const books = [
                {
                    id: "book1",
                    category: "Crypting & Clan Chests",
                    title: "CITADEL STRATEGY",
                    author: "[LTZ] Badder",
                    content: citadelContent
                },
                { id: "book2", category: "Crypting & Clan Chests", title: "Book2", content: lorem },
                { id: "book3", category: "Crypting & Clan Chests", title: "Book3", content: lorem },
                {
                    id: "book4",
                    category: "Events & Epic Monsters",
                    title: "ANCIENT VAULTS",
                    author: "[BBD] Heisenberg",
                    content: ancientVaultsContent
                },
                {
                    id: "book5",
                    category: "Events & Epic Monsters",
                    title: "TINMAN STRATEGY",
                    author: "[BBD] Heisenberg",
                    content: tinmanContent
                },
                { id: "book6", category: "Events & Epic Monsters", title: "Book6", content: lorem },
                { id: "book7", category: "Player Versus Player", title: "Book7", content: lorem },
                { id: "book8", category: "Player Versus Player", title: "Book8", content: lorem },
                { id: "book9", category: "Player Versus Player", title: "Book9", content: lorem },
                {
                    id: "book10",
                    category: "Miscellaneous",
                    title: "HALL OF FAME",
                    author: "[LTZ] Badder",
                    content: hallOfFameContent
                },
                { id: "book11", category: "Miscellaneous", title: "Book11", content: lorem },
                { id: "book12", category: "Miscellaneous", title: "Book12", content: lorem }
            ];

            const t = (key) => (window.I18N && typeof I18N.t === "function" ? I18N.t(key) : key);

            document.addEventListener("DOMContentLoaded", () => {
                const outline = document.getElementById("library-outline");
                const results = document.getElementById("library-results");
                const count = document.getElementById("library-result-count");
                const searchInput = document.getElementById("library-search");

                const modal = document.getElementById("book-modal");
                const modalCategory = document.getElementById("book-category");
                const modalTitle = document.getElementById("book-title");
                const modalContent = document.getElementById("book-content");
                const modalMedia = document.getElementById("book-media");
                const modalImage = document.getElementById("book-image");

                const groupByCategory = () => {
                    const grouped = {};
                    books.forEach((book) => {
                        if (!grouped[book.category]) grouped[book.category] = [];
                        grouped[book.category].push(book);
                    });
                    return grouped;
                };

                const buildBookLabel = (book) => {
                    const wrapper = document.createElement("span");
                    wrapper.className = "book-label";

                    const title = document.createElement("span");
                    title.className = "book-title";
                    title.textContent = book.title;
                    wrapper.appendChild(title);

                    if (book.author) {
                        const author = document.createElement("span");
                        author.className = "pill book-author";
                        author.textContent = book.author;
                        wrapper.appendChild(author);
                    }

                    return wrapper;
                };

                const renderOutline = () => {
                    const grouped = groupByCategory();
                    outline.innerHTML = "";
                    Object.entries(grouped).forEach(([category, list]) => {
                        const details = document.createElement("details");
                        details.className = "category-block";

                        const summary = document.createElement("summary");
                        summary.textContent = `${category} (${list.length})`;

                        const booksWrap = document.createElement("div");
                        booksWrap.className = "category-books";
                        list.forEach((book) => {
                            const btn = document.createElement("button");
                            btn.type = "button";
                            btn.className = "book-link";
                            btn.dataset.book = book.id;
                            btn.appendChild(buildBookLabel(book));
                            booksWrap.appendChild(btn);
                        });

                        details.append(summary, booksWrap);
                        outline.appendChild(details);
                    });
                };

                const renderResults = (items, query) => {
                    results.innerHTML = "";
                    if (!query) {
                        results.classList.add("is-hidden");
                        return;
                    }
                    results.classList.remove("is-hidden");

                    if (!items.length) {
                        const empty = document.createElement("div");
                        empty.className = "result-empty";
                        empty.textContent = t("library.search.empty");
                        results.appendChild(empty);
                        return;
                    }

                    items.forEach((book) => {
                        const row = document.createElement("button");
                        row.type = "button";
                        row.className = "book-result";
                        row.dataset.book = book.id;
                        row.appendChild(buildBookLabel(book));

                        const category = document.createElement("span");
                        category.className = "book-result__category";
                        category.textContent = book.category;
                        row.appendChild(category);

                        results.appendChild(row);
                    });
                };

                const updateCount = (value, isSearch) => {
                    if (isSearch) {
                        const label = value === 1 ? t("library.count.match") : t("library.count.matches");
                        count.textContent = `${value} ${label}`;
                        return;
                    }
                    count.textContent = `${value} ${t("library.count.books")}`;
                };

                const openBook = (id) => {
                    const book = books.find((item) => item.id === id);
                    if (!book) return;
                    modalCategory.textContent = book.category;
                    modalTitle.textContent = book.title;
                    modalContent.innerHTML = book.content || "";
                    if (book.image) {
                        modalImage.src = book.image;
                        modalImage.alt = book.title;
                        modalMedia.classList.remove("is-hidden");
                    } else {
                        modalImage.src = "";
                        modalImage.alt = "";
                        modalMedia.classList.add("is-hidden");
                    }
                    modal.classList.add("is-open");
                    modal.setAttribute("aria-hidden", "false");
                    document.body.classList.add("modal-open");

                    const params = new URLSearchParams(window.location.search);
                    params.set("book", book.id);
                    history.replaceState({}, "", `${window.location.pathname}?${params}`);
                };

                const closeBook = () => {
                    modal.classList.remove("is-open");
                    modal.setAttribute("aria-hidden", "true");
                    document.body.classList.remove("modal-open");
                    const params = new URLSearchParams(window.location.search);
                    params.delete("book");
                    history.replaceState({}, "", `${window.location.pathname}?${params}`);
                };

                const handleSearch = () => {
                    const query = searchInput.value.trim().toLowerCase();
                    const matches = books.filter((book) =>
                        book.title.toLowerCase().includes(query) || book.category.toLowerCase().includes(query)
                    );
                    renderResults(matches, query);
                    updateCount(query ? matches.length : books.length, Boolean(query));

                    const params = new URLSearchParams(window.location.search);
                    if (query) {
                        params.set("q", query);
                    } else {
                        params.delete("q");
                    }
                    history.replaceState({}, "", `${window.location.pathname}?${params}`);
                };

                outline.addEventListener("click", (event) => {
                    const target = event.target.closest("[data-book]");
                    if (target) {
                        openBook(target.dataset.book);
                    }
                });

                results.addEventListener("click", (event) => {
                    const target = event.target.closest("[data-book]");
                    if (target) {
                        openBook(target.dataset.book);
                    }
                });

                modal.addEventListener("click", (event) => {
                    if (event.target.closest("[data-book-close]")) {
                        closeBook();
                    }
                });

                document.addEventListener("keydown", (event) => {
                    if (event.key === "Escape" && modal.classList.contains("is-open")) {
                        closeBook();
                    }
                });

                searchInput.addEventListener("input", handleSearch);
                document.addEventListener("tb-language-change", handleSearch);

                renderOutline();

                const params = new URLSearchParams(window.location.search);
                const query = params.get("q");
                if (query) {
                    searchInput.value = query;
                }
                handleSearch();
                const bookParam = params.get("book");
                if (bookParam) {
                    openBook(bookParam);
                }
            });
        })();
    </script>
</body>
</html>
